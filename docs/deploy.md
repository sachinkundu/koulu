# Koulu — Railway Deployment Guide

Deploy Koulu to Railway from zero to a working production (or staging) environment.

## Prerequisites

| Requirement | How to get it |
|-------------|---------------|
| Railway account | [railway.com](https://railway.com) — free hobby tier works |
| Railway CLI | `npm install -g @railway/cli` |
| Resend account | [resend.com](https://resend.com) — free 100 emails/day |

## Quick Start (Automated)

```bash
# 1. Login and link your Railway project
railway login
railway init                  # or: railway link (for existing project)

# 2. Run the deployment script
./scripts/deploy-railway.sh

# 3. Set your Resend API key (the only manual step)
railway variable set RESEND_API_KEY=re_your_api_key_here
```

That's it. The script handles everything else: provisioning PostgreSQL + Redis, generating secrets, setting all environment variables, deploying, and health-checking.

### Script Options

```bash
./scripts/deploy-railway.sh                          # Deploy to production (default)
./scripts/deploy-railway.sh --environment staging    # Create & deploy a staging env
./scripts/deploy-railway.sh --dry-run                # Preview without changes
./scripts/deploy-railway.sh --skip-deploy            # Set up vars only, no deploy
./scripts/deploy-railway.sh --timeout 300            # Custom health check timeout
```

## What the Script Does

| Step | Action | Details |
|------|--------|---------|
| 1 | Preflight checks | Verifies Railway CLI, login, project link |
| 2 | Environment setup | Creates or links the target environment |
| 3 | Provision services | Adds PostgreSQL + Redis (skips if existing) |
| 4 | Set env vars | Generates secrets, configures app/email/JWT |
| 5 | Deploy | Triggers `railway up` from Dockerfile |
| 6 | Health check | Polls `/health` until 200 or timeout |

The script is **idempotent** — safe to re-run. It detects existing services and variables, skipping anything already configured.

## Manual Walkthrough

If you prefer to understand each step or need to debug, here's the full manual process.

### 1. Install & Login

```bash
npm install -g @railway/cli
railway login
```

### 2. Create a Project

```bash
railway init
# Choose a project name, e.g., "koulu"
```

Or link an existing project:

```bash
railway link
# Select your project from the list
```

### 3. Add PostgreSQL

```bash
railway add --database postgres
```

Railway automatically injects `DATABASE_URL` into your service. The Dockerfile's CMD converts `postgresql://` to `postgresql+asyncpg://` for async support.

### 4. Add Redis

```bash
railway add --database redis
```

Railway automatically injects `REDIS_URL`. Used for JWT token blacklisting and rate limiting.

### 5. Link to Your App Service

After adding databases, link back to your main service:

```bash
railway service link koulu
```

### 6. Set Environment Variables

```bash
# Application
railway variable set APP_ENV=production
railway variable set APP_DEBUG=false
railway variable set APP_SECRET_KEY=$(openssl rand -base64 48 | tr -d '\n/+=' | head -c 64)

# JWT
railway variable set JWT_SECRET_KEY=$(openssl rand -base64 48 | tr -d '\n/+=' | head -c 64)
railway variable set JWT_ALGORITHM=HS256
railway variable set JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
railway variable set JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
railway variable set JWT_REFRESH_TOKEN_REMEMBER_ME_DAYS=30

# Email (Resend HTTP API — NOT SMTP, Railway blocks SMTP ports)
railway variable set RESEND_API_KEY=re_your_resend_api_key
railway variable set MAIL_FROM=onboarding@resend.dev
railway variable set MAIL_FROM_NAME=Koulu

# Frontend URL (for links in emails, CORS)
railway variable set FRONTEND_URL=https://your-app.up.railway.app

# Rate limiting
railway variable set RATE_LIMIT_ENABLED=true
```

### 7. Deploy

Push to main (auto-deploys via Railway GitHub integration):

```bash
git push origin main
```

Or deploy manually:

```bash
railway up
```

### 8. Verify

```bash
curl https://your-app.up.railway.app/health
# Expected: {"status":"healthy"}
```

## Environment Variable Reference

### Required (must be set for production)

| Variable | Example | Notes |
|----------|---------|-------|
| `APP_ENV` | `production` | Enables CORS restriction, HSTS, JSON logging |
| `APP_SECRET_KEY` | (64-char random) | CSRF/session tokens. Auto-generated by script |
| `DATABASE_URL` | (auto-injected) | Railway sets this when you add PostgreSQL |
| `REDIS_URL` | (auto-injected) | Railway sets this when you add Redis |
| `JWT_SECRET_KEY` | (64-char random) | Token signing. Auto-generated by script |
| `FRONTEND_URL` | `https://app.up.railway.app` | Used in email links and CORS `allow_origins` |
| `RESEND_API_KEY` | `re_...` | Your Resend API key (HTTP API, not SMTP) |

### Optional (have sensible defaults)

| Variable | Default | Notes |
|----------|---------|-------|
| `APP_DEBUG` | `false` | Set `true` for DEBUG-level logs |
| `JWT_ALGORITHM` | `HS256` | |
| `JWT_ACCESS_TOKEN_EXPIRE_MINUTES` | `30` | |
| `JWT_REFRESH_TOKEN_EXPIRE_DAYS` | `7` | |
| `JWT_REFRESH_TOKEN_REMEMBER_ME_DAYS` | `30` | |
| `MAIL_FROM` | `onboarding@resend.dev` | Change when you verify a custom domain in Resend |
| `MAIL_FROM_NAME` | `Koulu` | |
| `RATE_LIMIT_ENABLED` | `true` | |

## What Happens on Deploy

The Dockerfile runs a multi-stage build:

```
1. Frontend build   — npm ci && npm run build (React → static files)
                      VITE_API_URL=/api/v1 is set at build time (relative URL)
2. Backend build    — pip install (Python dependencies)
3. Startup          — alembic upgrade head (migrations) → uvicorn (server)
```

Railway provides the `PORT` environment variable. The app listens on `0.0.0.0:$PORT`.

**Important**: The frontend API URL (`VITE_API_URL`) is baked in at Docker build time, not runtime. The Dockerfile defaults to `/api/v1` (relative), which resolves to the same domain the app is served from. This is correct for production where frontend and backend share a domain.

### Production Behaviors

When `APP_ENV=production`:
- **CORS**: Only allows requests from `FRONTEND_URL` (not `*`)
- **HSTS**: Sends `Strict-Transport-Security` header
- **Logging**: JSON format (structured, machine-parseable)
- **Static files**: Frontend SPA served from `/static/`

## Creating a Staging Environment

```bash
# One command — creates the environment with its own DB, Redis, and vars
./scripts/deploy-railway.sh --environment staging
```

This creates a completely isolated environment with:
- Its own PostgreSQL instance
- Its own Redis instance
- Separate env vars (own secrets, own `FRONTEND_URL`)

Staging URL will be something like `https://koulu-staging.up.railway.app`.

To switch between environments:

```bash
railway environment link production   # Switch to production
railway environment link staging      # Switch to staging
```

## Email Setup

Koulu uses [Resend](https://resend.com) for transactional email (verification, password reset).

### Without a Custom Domain (hobby/trial)

- Sender: `onboarding@resend.dev` (Resend's shared domain)
- Limit: 100 emails/day
- No DNS setup needed

### With a Custom Domain (later)

1. Add your domain in Resend dashboard
2. Add the DNS records (SPF, DKIM, DMARC)
3. Update the variable:
   ```bash
   railway variable set MAIL_FROM=noreply@yourdomain.com
   ```

## Troubleshooting

### Deploy fails during build

```bash
railway logs --build    # View build logs
```

Common causes:
- **Frontend build fails**: TypeScript errors. Run `cd frontend && npm run build` locally first
- **pip install fails**: Missing system dependency. Check Dockerfile `apt-get` line

### Deploy succeeds but app crashes

```bash
railway logs            # View runtime logs
```

Common causes:
- **Missing env var**: Check `railway variables` — all required vars must be set
- **DATABASE_URL format**: The Dockerfile CMD converts `postgresql://` → `postgresql+asyncpg://`. If you override `DATABASE_URL` manually, use the `postgresql://` prefix (not `postgresql+asyncpg://`)
- **Migration fails**: Connect to DB and check: `railway connect`

### Health check fails

Railway checks `GET /health` with a 120s timeout window. If it fails:
- The app may still be starting (migrations take time on first deploy)
- Check runtime logs: `railway logs --latest --lines 50` (look for `ImportError` or crash traces)
- Increase timeout in `railway.toml` if your DB has many migrations
- Check logs: `railway logs`

### Emails not sending

1. Verify `RESEND_API_KEY` is a real Resend API key (not the placeholder): `railway variables | grep RESEND`
2. Email uses Resend's **HTTP API** (not SMTP). Railway blocks SMTP ports (25, 465, 587)
3. With `onboarding@resend.dev` sender, emails only deliver to the Resend account owner's email. Verify a custom domain in Resend for arbitrary recipients
4. Check Resend dashboard for delivery status
5. Check app logs: `railway logs --lines 50 --filter "email"`

### CORS errors in browser

`FRONTEND_URL` must exactly match your app's URL:
```bash
railway variable set FRONTEND_URL=https://koulu-production.up.railway.app
```
No trailing slash. Must include `https://`.

### Rate limiting issues

If you're getting 429 errors during testing:
```bash
railway variable set RATE_LIMIT_ENABLED=false   # Temporarily disable
```

## Useful Commands

```bash
railway logs              # Live deployment logs
railway logs --build      # Build logs
railway variables         # List all env vars
railway open              # Open dashboard in browser
railway connect           # Connect to database shell (psql)
railway status            # Current project/environment/service info
railway service status    # Deployment status
railway redeploy          # Redeploy without code changes
railway restart           # Restart without rebuilding
```

## Architecture Overview

```
Railway Project
├── koulu (service)          ← Your app (Dockerfile)
│   ├── Frontend (React SPA) ← Served as static files
│   ├── Backend (FastAPI)    ← API + serves frontend
│   └── Migrations (Alembic) ← Run on every deploy
├── PostgreSQL (plugin)      ← Managed database
└── Redis (plugin)           ← Token blacklist + rate limiting
```

All services communicate via Railway's private network. The app service is the only one exposed to the internet.
